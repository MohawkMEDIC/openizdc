<?xml version="1.0" encoding="utf-8" ?>
<ProtocolDefinition xmlns="http://openiz.org/cdss" uuid="463FFFAD-FC37-4666-B949-4A96AE2A4FB9" id="BCG" name="BCG Vaccine Schedule">
  <!-- Younger than 5 only -->
  <when evaluation="and">
    <linqExpression>now.Subtract(DateOfBirth.Value.Date).TotalDays &lt;= 1825</linqExpression>
  </when>
  <rule id="BCG">
    <when evaluation="and">
      <!-- Patient does not have BCG -->
      <imsiExpression negationIndicator="true">participation[RecordTarget].source.participation[Product].player.typeConcept.mnemonic=VaccineType-BCG</imsiExpression>
    </when>
    <then>
      <action>
        <jsonModel>
          <![CDATA[
            {
				      "$type": "SubstanceAdministration",
              template: {
                  mnemonic: "act.substanceadmin.immunization"
              },
				      "moodConceptModel": { "id" : "ACF7BAF2-221F-4BC2-8116-CEB5165BE079", "mnemonic" : "PROPOSE" },
              "typeConceptModel": { "id" : "F3BE6B88-BC8F-4263-A779-86F21EA10A47", "mnemonic" : "InitialImmunization" },
              "statusConceptModel" : { "id" : "c8064cbd-fa06-4530-b430-1a52f1530c27", "mnemonic" : "ACTIVE" },
				      "doseSequence": 0,
              "doseQuantity" : 1.0,
             
              "doseUnitModel" : {
                "id": "a77b8d83-1cc9-4806-a268-5d1738154afa",
                "mnemonic" : "DOSE"
              },
              "routeModel" : {
                "id": "d594f99f-0151-41a0-a359-282ab54683a1",
                "mnemonic": "RouteOfAdministration-IM"
              },
              "siteModel" : {
                "id": "dd5db8ed-0d97-4728-bd94-27aacd79ea02",
                "mnemonic": 'Site-LeftArm'
              },
				      "participation": {
					      "Product": [{
                  "playerModel" : {
                    "$type" : "Material",
                    "id" : "ED144BD2-A334-40A2-9A8F-B767A1397D07",
                    "typeConceptModel": {
                      "id" : "19afe679-ef94-48b4-9d6a-3c9827c4c8e2",
                      "mnemonic": "VaccineType-BCG"
                    },
						        "name": {
							        "OfficialRecord": {
								        "component": {
									        "$other": ["BACILLUS CALMETTE-GUERIN VACCINE"]
								        }
							        },
                      "Assigned": {
								        "component": {
									        "$other": ["BCG"]
								        }
							        }
						        }
                  }
					      }]
				      }
			      }
          ]]>
        </jsonModel>
        <assign propertyName="ActTime">DateOfBirth.Value</assign>
        <assign propertyName="StartTime">DateOfBirth.Value</assign>
        <assign propertyName="StopTime">DateOfBirth.Value + new TimeSpan(2, 0, 0, 0)</assign>
      </action>
      
    </then>
  </rule>
</ProtocolDefinition>