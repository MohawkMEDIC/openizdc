<?xml version="1.0" encoding="UTF-8" ?>
<AppletManifest xmlns="http://openiz.org/applet">
  <info id="org.timr.applet.login" version="0.5.0.0">
    <icon>app://openiz.org/drawable/cog.png</icon>
    <name lang="en">Login Applet</name>
    <groupName lang="en">OpenIZ Core</groupName>
    <author>OpenIZ Community</author>
    <dependency id="org.openiz.core" version="0.5.0.0" />
    <dependency id="org.timr.applet.layout" version="0.5.0.0"/>
  </info>
  <asset name="index" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>login-controller</script>
      <title lang="en">Login</title>
      <title lang="sw">Ingia</title>

      <content>
        <div class="row" ng-controller="LoginController" xmlns="http://www.w3.org/1999/xhtml">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{ 'locale.panelLabels.login' | i18n }}</h2>
              </div>
              <div class="panel-body">
                <img src="app://openiz.org/asset/img/timr_logo_lg.png" class="img-responsive center-block" />
                <form novalidate="novalidate" name="loginForm" ng-submit="login(username, password)">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">{{ 'locale.panelLabels.loginHelper' | i18n }}</legend>
                    <div class="form-group" ng-class="{ 'has-error': (loginForm.username.$touched||loginForm.$submitted) &amp;&amp; loginForm.username.$invalid }">
                      <label for="usernameInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.username' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="username" type="text" ng-required="true" placeholder="{{ 'locale.placeHolders.username' | i18n }}" class="form-control" name="username" id="usernameInput"/>
                      </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-9" ng-messages="loginForm['username'].$error" ng-if="loginForm['username'].$touched||loginForm.$submitted">
                      <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.usernameRequired' | i18n }}</p>
                    </div>

                    <div class="form-group" ng-class="{ 'has-error': (loginForm.password.$touched||loginForm.$submitted) &amp;&amp; loginForm.password.$invalid }">
                      <label for="passwordInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.password' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="password" type="password" ng-required="true" placeholder="{{ 'locale.placeHolders.password' | i18n }}" class="form-control" name="password" id="passwordInput" />
                      </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-9" ng-messages="loginForm['password'].$error" ng-if="loginForm['password'].$touched||loginForm.$submitted">
                      <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.passwordRequired' | i18n }}</p>
                    </div>
                  </fieldset>
                  <div class ="row">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-success pull-left" href="app://openiz.org/applet/org.timr.applet.register/index">{{ 'locale.buttonLabels.register' | i18n }}</a>
                      <a class="btn btn-warning" href="app://openiz.org/applet/org.timr.applet.login/resetName">{{ 'locale.buttonLabels.forgotPassword' | i18n }}</a>
                      <button type="submit" class="btn btn-primary pull-right" >{{ 'locale.buttonLabels.login' | i18n }}</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetName" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{ 'locale.panelLabels.forgotPassword' | i18n }}</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate" name="resetPasswordForm" ng-submit="checkUsername(username)">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">{{ 'locale.panelLabels.enterUsername' | i18n }}</legend>
                    <br />
                    <div class="form-group" ng-class="{ 'has-error': (resetPasswordForm.username.$touched||resetPasswordForm.$submitted) &amp;&amp; resetPasswordForm.username.$invalid }">
                      <label for="usernameInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.username' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="username" type="text" ng-required="true" placeholder="{{ 'locale.inputLabels.username' | i18n }}" class="form-control" name="username" id="usernameInput" />
                      </div>
                      <div ng-messages="resetPasswordForm['username'].$error" ng-if="resetPasswordForm['username'].$touched||resetPasswordForm.$submitted">
                        <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.usernameRequired' | i18n }}</p>
                      </div>
                    </div>
                  </fieldset>
                  <div class ="row">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">{{ 'locale.buttonLabels.login' | i18n }}</a>
                      <button type="submit" class="btn btn-primary pull-right">{{ 'locale.buttonLabels.submit' | i18n }}</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetByEmail" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{ 'locale.text.codeSent' | i18n }}</h2>
              </div>
              <div class="panel-body">
                <div class="container">
                  <p>{{ 'locale.text.checkEmail' | i18n }}</p>
                  <div class ="form-group">
                    <div class="col-xs-10 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">{{ 'locale.buttonLabels.login' | i18n }}</a>
                      <a class="btn btn-primary pull-right" href="app://openiz.org/applet/org.timr.applet.login/newPassword">{{ 'locale.buttonLabels.codeReceived' | i18n }}</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetByPhone" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">We have sent you a verification code!</h2>
              </div>
              <div class="panel-body">
                <div class="container">
                  <p>Please check your phone and use the code received to reset your password.</p>
                  <div class ="form-group">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">{{ 'locale.buttonLabels.login' | i18n }}</a>
                      <a class="btn btn-primary pull-right" href="app://openiz.org/applet/org.timr.applet.login/newPassword">Received your code? Reset your password</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="reset" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{ 'locale.panelLabels.recoveryMethod' | i18n }}</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate">
                  <fieldset class="form-horizontal form-group">
                    <legend class="control-label">{{ 'locale.panelLabels.recoveryHelper' | i18n }}</legend>
                    <div class="form-group">
                      <div class="radio">
                        <label for="emailRadio" class="col-xs-4 radio-inline control-label">
                          <input id="emailRadio" class="col-xs-8" type="radio" name="resetMethod" value="Email" /> {{ 'locale.inputLabels.email' | i18n }}
                        </label>
                      </div>
                      <div class="radio">
                        <label for="phoneRadio" class="col-xs-4 radio-inline control-label">
                          <input id="phoneRadio" class="col-xs-8" type="radio" name="resetMethod" value="Phone" /> {{ 'locale.inputLabels.telephone' | i18n }}
                        </label>
                      </div>
                    </div>
                  </fieldset>
                  <div class ="form-group">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">{{ 'locale.buttonLabels.login' | i18n }}</a>
                      <a class="btn btn-primary pull-right" href="app://openiz.org/applet/org.timr.applet.login/newPassword">{{ 'locale.buttonLabels.sendCode' | i18n }}</a>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="newPassword" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{ 'locale.panelLabels.changePassword' | i18n }}</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate" name="resetPasswordForm" ng-submit="resetPassword(password, confirmPassword, verificationCode, resetPasswordForm.$invalid)">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">{{ 'locale.panelLabels.verificationHelper' | i18n }}</legend>
                    <div class="form-group" ng-class="{ 'has-error': (resetPasswordForm.verificationCode.$touched||resetPasswordForm.$submitted) &amp;&amp; resetPasswordForm.verificationCode.$invalid }">
                      <label for="verificationCodeInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.verificationCode' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="verificationCode" type="text" ng-required="true" placeholder="{{ 'locale.placeHolders.verificationCode' | i18n }}" class="form-control" name="verificationCode" id="verificationCodeInput" />
                      </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-9" ng-messages="resetPasswordForm.verificationCode.$error" ng-if="resetPasswordForm.verificationCode.$touched||resetPasswordForm.$submitted">
                      <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.verifyCodeRequired' | i18n }}</p>
                    </div>

                    <legend class="text-center">{{ 'locale.panelLabels.passwordHelper' | i18n }}</legend>
                    <div class="form-group" ng-class="{ 'has-error': (resetPasswordForm.password.$touched||resetPasswordForm.$submitted) &amp;&amp; resetPasswordForm.password.$invalid }">
                      <label for="passwordInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.password' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="password" ng-required="true" type="password" name="password" id="passwordInput" class="form-control" placeholder="{{ 'locale.placeHolders.password' | i18n }}" />
                      </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-9" ng-messages="resetPasswordForm['password'].$error" ng-if="resetPasswordForm['password'].$touched||resetPasswordForm.$submitted">
                      <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.passwordRequired' | i18n }}</p>
                    </div>

                    <div class="form-group" ng-class="{ 'has-error': (resetPasswordForm.confirmPassword.$touched||resetPasswordForm.$submitted) &amp;&amp; resetPasswordForm.confirmPassword.$invalid }">
                      <label for="confirmPasswordInput" class="col-xs-2 control-label">{{ 'locale.inputLabels.confirmPassword' | i18n }}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="confirmPassword" compare-to="password" ng-required="true" type="password" name="confirmPassword" id="confirmPasswordInput" class="form-control" placeholder="{{ 'locale.placeHolders.confirmPassword' | i18n }}" />
                      </div>
                    </div>
                    <div class="col-xs-offset-2 col-xs-9" ng-messages="resetPasswordForm['confirmPassword'].$error" ng-if="resetPasswordForm['confirmPassword'].$touched||resetPasswordForm.$submitted">
                      <p class="alert alert-danger" ng-message="required">{{ 'locale.errors.confirmPasswordRequired' | i18n }}</p>
                      <p class="alert alert-danger" ng-message="compareTo">{{ 'locale.errors.noMatch' | i18n }}</p>
                    </div>
                  </fieldset>
                  <div class="form-group">
                    <button type="submit" class="btn btn-primary pull-right">{{ 'locale.buttonLabels.resetPassword' | i18n }}</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="login-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
		    layoutApp.controller('LoginController', ['$scope', 'localize', function ($scope, localize)
		    { 
			    $scope.login = function(username, password) {
					$('#waitDialog').modal('show');
          
					OpenIZ.Authentication.loginAsync({
						userName: username, 
						password: password,
						continueWith: function(r) {
							if(r == null)
							{ 
								toastr.error(localize.getString('locale.toastrText.invalidForm'));
							}
							else
							{
                if(OpenIZ.urlParams['returnUrl'])
								  window.location.href = OpenIZ.urlParams['returnUrl']; 
                 else
                  window.location.href = "/applet/org.timr.applet.dashboard/index";
							}
						},
						onException : function(ex) {
							$('#waitDialog').modal('hide');
							if(ex.message)
								toastr.error(ex.message + ":" + ex.details);
							else
								toastr.error(localize.getString('locale.toastrText.unexpected'));
						}
					});
				};
			}]);
      ]]>
    </contentText>
  </asset>
  <asset name="reset-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
		    layoutApp.controller('ResetController', ['$scope', 'localize', function ($scope, localize)
		    {
			    $scope.checkUsername = function(username) {
            try
            {
              var result = OpenIZ.Authentication.checkUsername(username);
              if (result === 0)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/resetByEmail";
              }
              else if (result === 1)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/resetByPhone";
              }
              else if (result === 2)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/reset";
              }
              else
              {
                toastr.error(localize.getString('locale.toastrText.invalidUsername'));
              }
            }
            catch(ex)
            {
              toastr.error("Unexpected error, please contact the adminstrator");
            }
          };

          $scope.resetPassword = function(password, confirmPassword, verifyCode, invalid) {

              try
              {
                  var result = OpenIZ.Authentication.resetPassword(password, confirmPassword);
                  if(invalid){
                    toastr.error(localize.getString('toastrText.invalidForm'), localize.getString('locale.toastrHeaders.invalidForm'));
                  }
                  else if (result === 0)
                  {
                    window.location.href = "/applet/org.timr.applet.login/index";
                  }
                  else
                  {
                    toastr.error("Unable to reset password, please contact the administrator");
                  }
                }
                catch(ex)
                {
                  toastr.error("Unexpected error, please contact the adminstrator");
                }

          };
	    }]);
      ]]>
    </contentText>
  </asset>
</AppletManifest>