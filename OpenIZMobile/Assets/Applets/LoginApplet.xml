<?xml version="1.0" encoding="UTF-8" ?>
<AppletManifest xmlns="http://openiz.org/applet">
  <info id="org.timr.applet.login" version="0.5.0.0">
    <icon>app://openiz.org/drawable/cog.png</icon>
    <name lang="en">Login Applet</name>
    <groupName lang="en">OpenIZ Core</groupName>
    <author>OpenIZ Community</author>
    <dependency id="org.openiz.core" version="0.5.0.0" />
  </info>
  <strings lang="en">
    <string key="login">Login to</string>
    <string key="btnForgot">Forgot password</string>
    <string key="password">Password</string>
    <string key="username">User Name</string>
  </strings>
  <strings lang="sw">
    <string key="login">Login tosw</string>
    <string key="btnForgot">Forgot passwordsw</string>
    <string key="password">Passwordsw</string>
    <string key="username">User Namesw</string>
  </strings>
  <asset name="index" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>login-controller</script>
      <content>
        <div class="row" ng-controller="LoginController" xmlns="http://www.w3.org/1999/xhtml">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{locale.panelLabels.login}}</h2>
              </div>
              <div class="panel-body">
                <img src="app://openiz.org/drawable/coat_of_arms_of_tanzania.png" class="img-responsive center-block" />
                <form novalidate="novalidate" name="loginForm">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">{{locale.panelLabels.loginHelper}}</legend>
                    <div class="form-group" ng-class="{ 'has-error': loginForm.username.$touched &amp;&amp; loginForm.username.$invalid }">
                      <label for="usernameInput" class="col-xs-2 control-label">{{locale.inputLabels.username}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="username" type="text" ng-required="true" placeholder="{{locale.placeholders.username}}" class="form-control" name="username" id="usernameInput" />
                        <div ng-messages="loginForm['username'].$error" ng-if="loginForm['username'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.usernameRequired}}</p>
                        </div>
                      </div>
                    </div>

                    <div class="form-group" ng-class="{ 'has-error': loginForm.password.$touched &amp;&amp; loginForm.password.$invalid }">
                      <label for="passwordInput" class="col-xs-2 control-label">{{locale.inputLabels.password}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="password" type="password" ng-required="true" placeholder="{{locale.placeholders.password}}" class="form-control" name="password" id="passwordInput" />
                        <div ng-messages="loginForm['password'].$error" ng-if="loginForm['password'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.passwordRequired}}</p>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                  <div class ="row">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-success pull-left" href="app://openiz.org/applet/org.timr.applet.register/index">{{locale.buttonLabels.register}}</a>
                      <a class="btn btn-warning" href="app://openiz.org/applet/org.timr.applet.login/resetName">{{locale.buttonLabels.forgotPassword}}</a>
                      <a class="btn btn-warning" href="app://openiz.org/applet/org.timr.applet.patientAdministration/patientSearch">Search</a>
                      <button type="button" class="btn btn-primary pull-right" ng-click="login(username, password)">{{locale.buttonLabels.login}}</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetName" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">Forgot Password</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate" name="resetPasswordForm">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">Enter your User Name below</legend>
                    <br />
                    <div class="form-group" ng-class="{ 'has-error': resetPasswordForm.username.$touched &amp;&amp; resetPasswordForm.username.$invalid }">
                      <label for="usernameInput" class="col-xs-2 control-label">{{locale.inputLabels.username}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="username" type="text" ng-required="true" placeholder="{{locale.inputLabels.username}}" class="form-control" name="username" id="usernameInput" />
                        <div ng-messages="resetPasswordForm['username'].$error" ng-if="resetPasswordForm['username'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.usernameRequired}}</p>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                  <div class ="row">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">Return to Login</a>
                      <button type="button" class="btn btn-primary pull-right" ng-click="checkUsername(username)">Submit</button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetByEmail" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">Thank you!</h2>
              </div>
              <div class="panel-body">
                <div class="container">
                  <h3>We have sent you a verification code!</h3>

                  <p>Please check your email and use the code received to reset your password.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="resetByPhone" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">Thank you!</h2>
              </div>
              <div class="panel-body">
                <div class="container">
                  <h3>We have sent you a verification code!</h3>

                  <p>Please check your phone and use the code received to reset your password.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="reset" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">Password Recovery</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate">
                  <fieldset class="form-group">
                    <legend class="control-label">Select your recovery method</legend>
                    <div class="form-group">
                      <div class="radio row">
                        <label for="emailRadio" class="col-xs-4 radio-inline control-label">
                          <input id="emailRadio" class="col-xs-8" type="radio" name="resetMethod" value="Email" /> Email
                        </label>
                      </div>
                      <div class="radio row">
                        <label for="phoneRadio" class="col-xs-4 radio-inline control-label">
                          <input id="phoneRadio" class="col-xs-8" type="radio" name="resetMethod" value="Phone" /> Phone Number
                        </label>
                      </div>
                    </div>
                  </fieldset>
                  <div class ="row">
                    <div class="col-xs-12 text-center">
                      <a class="btn btn-danger pull-left" href="app://openiz.org/applet/org.timr.applet.login/index">Return to Login</a>
                      <a class="btn btn-primary pull-right" href="app://openiz.org/applet/org.timr.applet.login/verify">Send Verification Code</a>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="newPassword" mimeType="text/html">
    <contentHtml>
      <!-- absolute reference to the layout -->
      <layout>app://openiz.org/applet/org.timr.applet.layout/layout</layout>
      <script>reset-controller</script>
      <content>
        <div class="row" xmlns="http://www.w3.org/1999/xhtml" ng-controller="ResetController">
          <div class="col-xs-12">
            <div class="panel panel-default">
              <div class="panel-heading">
                <h2 class="panel-title text-center">{{locale.panelLabels.changePassword}}</h2>
              </div>
              <div class="panel-body">
                <form novalidate="novalidate" name="resetPasswordForm">
                  <fieldset class="form-horizontal form-group">
                    <legend class="text-center">{{locale.panelLabels.verificationHelper}}</legend>
                    <div class="form-group" ng-class="{ 'has-error': resetPasswordForm.verificationCode.$touched &amp;&amp; resetPasswordForm.verificationCode.$invalid }">
                      <label for="verifyInput" class="col-xs-2 control-label">{{locale.inputLabels.verificationCode}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="verificationCode" type="text" ng-required="true" placeholder="{{locale.placeholders.verificationCode}}" class="form-control" name="verificationCode" id="verificationCodeInput" />
                        <div ng-messages="registerForm['confirmPassword'].$error" ng-if="registerForm['confirmPassword'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.passwordRequired}}</p>
                        </div>
                      </div>
                    </div>

                    <legend class="text-center">{{locale.panelLabels.passwordHelper}}</legend>
                    <div class="form-group" ng-class="{ 'has-error': resetPasswordForm.password.$touched &amp;&amp; resetPasswordForm.password.$invalid }">
                      <label for="passwordInput" class="col-xs-2 control-label">{{locale.inputLabels.password}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="password" ng-required="true" type="password" name="password" id="passwordInput" class="form-control" placeholder="{{locale.placeholders.password}}" />
                        <div ng-messages="loginForm['password'].$error" ng-if="loginForm['password'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.passwordRequired}}</p>
                        </div>
                      </div>
                    </div>

                    <div class="form-group" ng-class="{ 'has-error': resetPasswordForm.confirmPassword.$touched &amp;&amp; resetPasswordForm.confirmPassword.$invalid }">
                      <label for="confirmPasswordInput" class="col-xs-2 control-label">{{locale.inputLabels.confirmPassword}}</label>
                      <div class="col-xs-9 input-group">
                        <input ng-model="confirmPassword" ng-required="true" type="password" name="confirmPassword" id="confirmPasswordInput" class="form-control" placeholder="{{locale.placeholders.confirmPassword}}" />
                        <div ng-messages="registerForm['confirmPassword'].$error" ng-if="registerForm['confirmPassword'].$touched">
                          <p class="alert alert-danger" ng-message="required">{{locale.errors.passwordRequired}}</p>
                          <p class="alert alert-danger" ng-message="noMatch">{{locale.errors.noMatch}}</p>
                        </div>
                      </div>
                    </div>
                  </fieldset>
                  <div class="form-group">
                    <button type="button" class="btn btn-primary pull-right" ng-click="resetPassword(password, confirmPassword, verificationCode, resetPasswordForm.$invalid)">{{locale.buttonLabels.resetPassword}}</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="login-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[

		    layoutApp.controller('LoginController', ['$scope', function ($scope)
		    {
			    $scope.login = function(username, password) {
            try
            {
              var session = OpenIZ.Authentication.login(username, password);

              console.log(session);
              if(session == null)
              {
                toastr.error("Incorrect username or password");
              }
              else
              {
                toastr.success("Login successful");
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.openiz.applet.dashboard/index";
              }
            }
            catch(ex)
            {
              toastr.error("Unexpected error, please contact the adminstrator");
            }
          };

	    }]);
      ]]>
    </contentText>
  </asset>
  <asset name="reset-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
		    layoutApp.controller('ResetController', ['$scope', function ($scope)
		    {
			    $scope.checkUsername = function(username) {
            try
            {
              var result = OpenIZ.Authentication.checkUsername(username);
              if (result === 0)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/resetByEmail";
              }
              else if (result === 1)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/resetByPhone";
              }
              else if (result === 2)
              {
                window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/reset";
              }
              else
              {
                toastr.error("Unknown or invalid username");
              }
            }
            catch(ex)
            {
              toastr.error("Unexpected error, please contact the adminstrator");
            }
          };

          $scope.resetPassword = function(password, confirmPassword, verifyCode, invalid) {

              try
              {
                  var result = OpenIZ.Authentication.resetPassword(password, confirmPassword);
                  if(invalid){
                    toastr.error("Check Fields, Data entered is invalid");
                  }
                  else if (result === 0)
                  {
                    window.location.href = window.location.protocol + "//" + window.location.hostname + ":" + window.location.port + "/applet/org.timr.applet.login/index";
                  }
                  else
                  {
                    toastr.error("Unable to reset password, please contact the administrator");
                  }
                }
                catch(ex)
                {
                  toastr.error("Unexpected error, please contact the adminstrator");
                }

          };
	    }]);
      ]]>
    </contentText>
  </asset>
</AppletManifest>