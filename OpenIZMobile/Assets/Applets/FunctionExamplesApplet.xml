<?xml version="1.0" encoding="utf-8" ?>
<AppletManifest xmlns="http://openiz.org/applet">
  <info id="org.openiz.applet.test" version="0.5.0.0">
    <name lang="en">Function Tests</name>
    <author>OpenIZ Community</author>
    <demand>1.3.6.1.4.1.33349.3.1.5.9.2.1</demand>
  </info>
  <strings lang="en">
    <string key="concept_header">Concept Tests</string>
    <string key="concept_dropdown">Concept:</string>
  </strings>
  <asset name="index" mimeType="text/html">
    <contentHtml>
      <bundle>jquery</bundle>
      <bundle>bootstrap</bundle>
      <bundle>angular</bundle>
      <bundle>select2</bundle>
      <script>index-controller</script>
      <script>concept-test-controller</script>
      <content>
        <body xmlns="http://www.w3.org/1999/xhtml">
          <div class="container">
            <div class="row">
              <!-- #include virtual="concept-test" -->
            </div>
          </div>
        </body>
      </content>
    </contentHtml>
  </asset>
  <asset name="concept-test" mimeType="text/html">
    <contentHtml>
      <content>
        <div xmlns="http://www.w3.org/1999/xhtml" class="panel panel-default" ng-controller="ConceptTestController">
          <div class="panel-heading">
            <h3 class="panel-title">
              <a href="#concept_test_body" data-toggle="collapse">
                {{ 'concept_header' | i18n }}
              </a>
            </h3>
          </div>
          <div class="panel-body collapse in" id="concept_test_body">
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'concept_dropdown' | i18n }}</span>
                <select id="familyCode" size="1" style="width:100%" class="form-control" ng-model="status" ng-change="lookupConcept(status)" ></select>
              </div>
              <span>{{ 'concept_you_selected' | i18n }} : {{ statusConcept.mnemonic }}</span>
            </div>
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'concept_small' | i18n }}</span>
                <select size="1" style="width:100%" class="form-control" ng-model="second" ng-change="lookupConcept(status)" ></select>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="index-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
      
      // angular stuff
			var indexApp = angular.module('index', ['localization']);
      
      ]]>
    </contentText>
  </asset>
  <asset name="concept-test-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
      
      indexApp.controller('ConceptTestController', ['$scope', function($scope) {
      
        //$scope.codes = OpenIZ.Concept.findConceptSet("mnemonic=FamilyMember").first("ConceptSet").toSelectModel();
        $scope.status = null;
        $scope.statusConcept = null;
        
        $scope.lookupConcept = function(status)
        {
          $scope.statusConcept = OpenIZ.Concept.getConcept(status);
        };
        
        $('#familyCode').select2({
          ajax : {
            delay : 500,
            transport : function(p, s, f) {
              if(p.data.term == undefined || p.data.term.length < 3) return;
              var s2 = OpenIZ.Concept.findConceptAsync(
                {
                  query: '_expand=name&conceptSet.mnemonic=FamilyMember&name.value=~' + p.data.term, 
                  continueWith: function(r) {
                    s({ results: r.toSelectModel("Concept") });
                  }
                }
              );
            }
          }
        });
      }]);
      ]]>
    </contentText>
  </asset>
</AppletManifest>