<?xml version="1.0" encoding="utf-8" ?>
<AppletManifest xmlns="http://openiz.org/applet">
  <info id="org.timr.applet.test" version="0.5.0.0">
    <name lang="en">Function Tests</name>
    <author>OpenIZ Community</author>
    <!--demand>1.3.6.1.4.1.33349.3.1.5.9.2.1</demand-->
  </info>
  <strings lang="en">
    <string key="concept_header">Concept Tests</string>
    <string key="concept_dropdown">Concept:</string>
  </strings>
  <asset name="index" mimeType="text/html">
    <contentHtml>
      <bundle>jquery</bundle>
      <bundle>bootstrap</bundle>
      <bundle>angular</bundle>
      <bundle>select2</bundle>
      <script>index-controller</script>
      <script>concept-test-controller</script>
      <script>patient-test-controller</script>
      
      <content>
        <body xmlns="http://www.w3.org/1999/xhtml">
          <div class="container">
            <div class="row">
              <!-- #include virtual="concept-test" -->
            </div>
            <div class="row">
              <!-- #include virtual="patient-test" -->
            </div>
          </div>
        </body>
      </content>
    </contentHtml>
  </asset>
  <asset name="patient-test" mimeType="text/html">
    <contentHtml>
      <content>
        <div xmlns="http://www.w3.org/1999/xhtml" class="panel panel-default" ng-controller="PatientTestController">
          <div class="panel-heading">
            <h3 class="panel-title">
              <a href="#patient_test_body" data-toggle="collapse">
                {{ patient_header | i18n }}
              </a>
            </h3>
          </div>
          <div class="panel-body collapse in">
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'family_name' | i18n }}:</span>
                <input class="form-control" type="text" ng-model="family"/>
              </div>
            </div>
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'given_name' | i18n }}:</span>
                <input class="form-control" type="text" ng-model="given"/>
              </div>
            </div>
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'birthdate' | i18n }}:</span>
                <input class="form-control" data-max-date="0" type="date" ng-model="dob"/>
              </div>
            </div>
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'gender' | i18n }}:</span>
                <select size="1" style="width:100%" class="form-control"  ng-model="gender" ng-options="concept.id as concept.text for concept in genderConcepts"></select>
              </div>
            </div>
            <div class="btn-group" role="group">
              <button type="button" ng-click="save()" class="btn-lg btn-primary">{{ 'save' | i18n }}</button>
              <button type="button" ng-click="searchTest()" class="btn-lg btn-primary">{{ 'save' | i18n }}</button>
            </div>
            <div class="row">
              <div class="col-md-12">
                <pre>
                  {{ $scope.createdPatient | json }}
                </pre>
              </div>
            </div>
        </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="concept-test" mimeType="text/html">
    <contentHtml>
      <content>
        <div xmlns="http://www.w3.org/1999/xhtml" class="panel panel-default" ng-controller="ConceptTestController">
          <div class="panel-heading">
            <h3 class="panel-title">
              <a href="#concept_test_body" data-toggle="collapse">
                {{ 'concept_header' | i18n }}
              </a>
            </h3>
          </div>
          <div class="panel-body collapse in" id="concept_test_body">
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'concept_dropdown' | i18n }}</span>
                <select id="familyCode" size="1" style="width:100%" class="form-control" ng-model="status" ng-change="lookupConcept(status)" ></select>
              </div>
              <span>{{ 'concept_you_selected' | i18n }} : {{ statusConcept.mnemonic }}</span>
            </div>
            <div class="row">
              <div class="input-group">
                <span class="input-group-addon">{{ 'concept_small' | i18n }}</span>
                <select size="1" style="width:100%" class="form-control" ng-model="concept" ng-change="lookupConcept(concept)" ng-options="concept.id as concept.text for concept in concepts" ></select>
              </div>
            </div>
          </div>
        </div>
      </content>
    </contentHtml>
  </asset>
  <asset name="index-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
      
      // angular stuff
			var indexApp = angular.module('index', ['localization']);
      
      ]]>
    </contentText>
  </asset>
  <asset name="patient-test-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
        indexApp.controller('PatientTestController', ['$scope', function($scope) {
          $scope.genderConcepts =  OpenIZ.Concept.findConceptSet("mnemonic=ActStatus").first("ConceptSet").toSelectModel();

          $scope.save = function() {
            var patientData = {
              dateOfBirth : $scope.dob,
              dateOfBirthPrecision : 'Year',
              genderConcept : $scope.gender,
              name : [{
                use : OpenIZModel.NameUseKeys.Legal,
                component : [
                  {
                    type : OpenIZModel.NameComponentKeys.Given,
                    value : $scope.given
                  },
                  {
                    type : OpenIZModel.NameComponentKeys.Family,
                    value : $scope.family
                  }
                ]
              }]
            };
            var patient = new OpenIZModel.Patient(patientData);
            OpenIZ.Patient.insertAsync({
              patient : patient,
              continueWith : function(result) { 
                alert("Inserted as " + result.id); 
                OpenIZ.Patient.getAsync({
                  patientId : result.id,
                  continueWith : function(fullPatient) {
                    alert(JSON.stringify(fullPatient.toImsi()));
                    $scope.createdPatient = fullPatient.toImsi();
                  }
                });
              },
              onException : function(ex) { alert("Error " + ex); }
            });
          };
        }]);
      ]]>
    </contentText>
  </asset>
  <asset name="concept-test-controller" mimeType="text/javascript">
    <contentText>
      <![CDATA[
      
      indexApp.controller('ConceptTestController', ['$scope', function($scope) {
      
        $scope.concepts = OpenIZ.Concept.findConceptSet("mnemonic=ActStatus").first("ConceptSet").toSelectModel();
        $scope.status = null;
        $scope.statusConcept = null;
        
        $scope.lookupConcept = function(status)
        {
          $scope.statusConcept = OpenIZ.Concept.getConcept(status);
        };
        
        $('#familyCode').select2({
          ajax : {
            delay : 500,
            transport : function(p, s, f) {
              if(p.data.term == undefined || p.data.term.length < 3) return;
              var s2 = OpenIZ.Concept.findConceptAsync(
                {
                  query: '_expand=name&conceptSet.mnemonic=FamilyMember&name.value=~' + p.data.term, 
                  continueWith: function(r) {
                    s({ results: r.toSelectModel("Concept") });
                  }
                }
              );
            }
          }
        });
      }]);
      ]]>
    </contentText>
  </asset>
</AppletManifest>