<?xml version="1.0" encoding="utf-8" ?>
<DatamartSchema xmlns="http://openiz.org/warehousing" name="oizcp" id="07BA63B4-50FA-41D5-9D24-7FB41606A961">
  <property name="creation_date" type="date" attributes="nonnull"/>
  <property name="patient_id" type="uuid" attributes="nonnull index"/>
  <property name="location_id" type="uuid" attributes="index"/>
  <property name="protocol_id" type="uuid" attributes="index"/>
  <property name="act_id" type="uuid" attributes="nonnull"/>
  <property name="class_id" type="uuid" attributes="nonnull"/>
  <property name="type_id" type="uuid" attributes="nonnull"/>
  <property name="min_date" type="date" attributes="nonnull"/>
  <property name="max_date" type="date" attributes="none"/>
  <property name="act_date" type="date" attributes="index"/>
  <property name="product_id" type="uuid" attributes="index"/>
  <sqp name="bymonth" provider="sqlite">
    <![CDATA[SELECT location_id, product_id, act_date, COUNT(act_id) AS acts FROM oizcp 
    GROUP BY location_id, product_id, act_date]]>
  </sqp>
  <sqp name="defaulters_aggregate" provider="sqlite">
    <![CDATA[
    SELECT -overdue AS days_overdue, location_id, COUNT(patient_id) AS num_children FROM
    (SELECT patient_id, location_id, max_date - CURRENT_TIMESTAMP AS overdue FROM oizcp WHERE product_id IS NOT NULL AND max_date IS NOT NULL AND max_date < CURRENT_TIMESTAMP GROUP BY patient_id) WHERE overdue > 0 GROUP BY overdue, location_id
    ]]>
  </sqp>
  <sqp name="defaulters" provider="sqlite">
    <![CDATA[
    SELECT patient_id, location_id, CURRENT_TIMESTAMP - max_date AS overdue, product_id FROM oizcp WHERE product_id IS NOT NULL AND max_date IS NOT NULL AND max_date < CURRENT_TIMESTAMP 
    ]]>
  </sqp>
</DatamartSchema>