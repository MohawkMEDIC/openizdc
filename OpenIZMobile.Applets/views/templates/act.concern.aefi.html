<!--
 - Copyright 2015-2017 Mohawk College of Applied Arts and Technology
 -
 - 
 - Licensed under the Apache License, Version 2.0 (the "License"); you 
 - may not use this file except in compliance with the License. You may 
 - obtain a copy of the License at 
 - 
 - http://www.apache.org/licenses/LICENSE-2.0 
 - 
 - Unless required by applicable law or agreed to in writing, software
 - distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 - WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the 
 - License for the specific language governing permissions and limitations under 
 - the License.
 - 
 - User: justi
 - Date: 2017-3-31
 -->
<div xmlns="http://www.w3.org/1999/xhtml" xmlns:oiz="http://openiz.org/applet" xmlns:bind="http://openiz.org/applet/binding" class="form-group">
    <div class="row">
        <div class="control-label col-xs-12">
            <label class="control-label">
                {{ 'locale.encounters.aefi.title' | i18n }}
            </label><br />
        </div>
        <div class="container-fluid">
            <div class="row">
                <div class="col-xs-8">
                    <label>
                        {{ 'locale.encounters.aefi.drug' | i18n }}
                    </label>
                    <select ng-class="{'has-error':(editEncounterForm['aefiDrug_' + act.targetModel.id].$touched||editEncounterForm.$submitted) &amp;&amp; editEncounterForm['aefiDrug_' + act.targetModel.id].$invalid}" 
                            name="aefiDrug_{{act.targetModel.id}}" 
                            required="required" 
                            class="form-control" 
                            data-default-key="70fe34ce-caff-4f46-b6e6-9cd6d8f289d6"
                            ng-model="act.targetModel.relationship.RefersTo.target" 
                            ng-change="bindRelationship(act.targetModel, 'RefersTo', act.targetModel.relationship.RefersTo.target, 'act.relationship.HasSubject.targetModel.value = (act.relationship.RefersTo.targetModel.participation.Consumable || act.relationship.RefersTo.targetModel.participation.Product).playerModel.typeConceptModel.id; act.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.startTime = act.relationship.RefersTo.targetModel.actTime')"
                            oiz-databind="Act" 
                            data-filter='{ "participation[RecordTarget].player" : "{{ patient.id }}", "statusConcept" : "afc33800-8225-4061-b168-bacc09cdbae3", "classConcept" : "932a3c7e-ad77-450a-8a1f-030fc2855450" }' 
                            data-display="OpenIZ.Util.renderName(scope.participation.Product.playerModel.name.Assigned) + ' ' + OpenIZ.Localization.getString('locale.encounters.immunization.doseSequence') + ' ' + scope.doseSequence" 
                            data-key="scope.id">
                        <option value="70fe34ce-caff-4f46-b6e6-9cd6d8f289d6" selected="selected">{{ 'locale.encounters.aefi.unknown' | i18n }}</option>
                    </select>
                </div>
                <div class="col-xs-4">
                    <label>
                        {{ 'locale.encounters.immunizations.lot' | i18n }}
                    </label>
                    <select ng-class="{'has-error':(editEncounterForm['aefiLot_' + act.targetModel.id].$touched||editEncounterForm.$submitted) &amp;&amp; editEncounterForm['aefiLot_' + act.targetModel.id].$invalid}"
                            name="aefiLot_{{act.targetModel.id}}"
                            required="required"
                            class="form-control"
                            data-watch="act.targetModel.relationship.RefersTo.targetModel.participation.Product.player"
                            data-watch-target="relationship[ManufacturedProduct].source"
                            ng-model="act.targetModel.relationship.RefersTo.targetModel.participation.Consumable.playerModel.lotNumber"
                            oiz-databind="ManufacturedMaterial"
                            data-filter='{ "relationship[ManufacturedProduct].source" : "{{ act.targetModel.relationship.RefersTo.targetModel.participation.Product.player }}" }'
                            data-display="scope.lotNumber"
                            data-defaultEmpty="true"
                            data-defaultFirst="true"
                            data-key="scope.id">
                    </select>

                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <span ng-if="act.targetModel.relationship.RefersTo">
                        ( {{ 'locale.encounters.date' | i18n }} : {{ act.targetModel.relationship.RefersTo.targetModel.actTime | date: 'yyyy-MM-dd' }}, 
                        {{ 'locale.encounters.immunization.doseSequence' | i18n }} :
                        {{ act.targetModel.relationship.RefersTo.targetModel.doseSequence }},
                        {{ 'locale.encounters.immunizations.site' | i18n }} :
                        {{ act.targetModel.relationship.RefersTo.targetModel.siteModel | oizConcept }} )
                    </span>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <label>{{ 'locale.encounters.aefi.detailsOfAdverseReaction.title' | i18n }}</label>
                    <select required="required" ng-class="{'has-error':(editEncounterForm['aefiReaction_' + act.targetModel.id].$touched||editEncounterForm.$submitted) &amp;&amp; editEncounterForm['aefiReaction_' + act.targetModel.id].$invalid}" name="aefiReaction_{{act.targetModel.id}}" class="form-control" ng-model="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.value" bind:source="Concept" bind:filter="statusConcept.mnemonic=ACTIVE&amp;conceptSet.mnemonic=ReactionObservation" bind:value="name[{{ locale }}].value">
                        <option value="" disabled="disabled" selected="selected">{{ 'locale.encounters.aefi.manifestation' | i18n }}</option>
                    </select>

                </div>
                <div class="col-xs-12 help-block text-danger" ng-if="editEncounterForm['aefiReaction_' + act.targetModel.id].$error.required &amp;&amp; (editEncounterForm['aefiReaction_' + act.targetModel.id].$touched || editEncounterForm.$submitted)">
                    {{ 'locale.encounters.aefi.errors.detailsOfAdverseReactionRequired' | i18n }}
                </div>
            </div>
            <div class="row">
                <div class="col-xs-6">
                    <label>{{ 'locale.encounters.aefi.dateReactionStarted.title' | i18n }}</label>
                    <input class="form-control" ng-model="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.startTime" type="date" required="required" />
                </div>
                <div class="col-xs-6">
                    <div class="row">
                        <div class="col-xs-12">
                            <label>
                                {{ 'locale.encounters.aefi.dateReactionStopped.title' | i18n }}
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-2">
                            <label class="control control--checkbox">
                                <input type="checkbox" ng-model="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.statusConcept"
                                       ng-true-value="'afc33800-8225-4061-b168-bacc09cdbae3'" ng-false-value="'c8064cbd-fa06-4530-b430-1a52f1530c27'" />
                                <div class="control__indicator control__indicator_alt"></div>
                            </label>
                        </div>
                        <div class="col-xs-10">
                            <input class="form-control" ng-model="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.stopTime" type="date" min="{{act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.startTime | date: 'yyyy-MM-dd' }}" max="{{ $root.page.maxEventTime | date: 'yyyy-MM-dd' }}" ng-disabled="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.statusConcept != 'afc33800-8225-4061-b168-bacc09cdbae3'" ng-required="act.targetModel.relationship.HasSubject.targetModel.relationship.HasManifestation.targetModel.statusConcept == 'afc33800-8225-4061-b168-bacc09cdbae3'" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <label>{{ 'locale.encounters.aefi.managementOfReaction.seriousnessOfReaction.title' | i18n }}</label>
                </div>
            </div>
            <div class="row">
                <div class="col-xs-12">
                    <div class="row">
                        <div class="col-xs-6">
                            <div class="row">
                                <div class="col-xs-12">
                                    <select required="required" ng-class="{'has-error':(editEncounterForm['aefiSeverity_' + act.targetModel.id].$touched||editEncounterForm.$submitted) &amp;&amp; editEncounterForm['aefiSeverity_' + act.targetModel.id].$invalid}" name="aefiSeverity_{{act.targetModel.id}}" class="form-control" ng-model="act.targetModel.relationship.HasSubject.targetModel.relationship.HasComponent.targetModel.value" bind:source="Concept" bind:filter="statusConcept.mnemonic=ACTIVE&amp;conceptSet.mnemonic=SeverityObservation" bind:value="name[{{ locale }}].value">
                                        <option value="" disabled="disabled" selected="selected">{{ 'locale.encounters.aefi.severity' | i18n }}</option>
                                    </select>
                                </div>
                                <div class="col-xs-12 help-block text-danger" ng-if="editEncounterForm['aefiSeverity_' + act.targetModel.id].$error.required &amp;&amp; (editEncounterForm['aefiSeverity_' + act.targetModel.id].$touched || editEncounterForm.$submitted)">
                                    {{ 'locale.encounters.aefi.errors.reactionSeverityRequired' | i18n }}
                                </div>
                            </div>
                        </div>
                        <div class="col-xs-1">
                            <label class="control control--checkbox">
                                <input id="{{act.targetModel.id}}-patient-died"  type="checkbox" ng-model="patient._deceased"
                                       ng-click="patient._deceased ? addSubEncounter(encounter.relationship.HasComponent, 'act.observation.causeofdeath', act.targetModel.relationship, 'IsCauseOf') :  delSubEncounter(encounter.relationship.HasComponent, 'act.observation.causeofdeath', act.targetModel.relationship, 'IsCauseOf')" />
                                <div class="control__indicator control__indicator_alt" ></div>
                            </label>
                        </div>
                        <div class="col-xs-5">
                            <label class="lbl-checkbox" for="{{act.targetModel.id}}-patient-died">
                                {{ 'locale.encounters.aefi.outcomeOfReaction.died' | i18n }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-sm-6 col-xs-12">
                    <div class="row">
                        <div class="col-xs-2">
                            <label class="control control--checkbox">
                                <input id="{{act.targetModel.id}}-ongoing-concern" type="checkbox" ng-model="act.targetModel.statusConcept"
                                       ng-true-value="'c8064cbd-fa06-4530-b430-1a52f1530c27'" ng-false-value="'afc33800-8225-4061-b168-bacc09cdbae3'" />
                                <div class="control__indicator control__indicator_alt"></div>
                            </label>
                        </div>
                        <div class="col-xs-10">
                            <label class="lbl-checkbox" for="{{act.targetModel.id}}-ongoing-concern">
                                {{ 'locale.encounters.aefi.isOngoingConcern' | i18n }}
                            </label>
                        </div>
                    </div>
                </div>
                <div class="col-sm-6 col-xs-12">
                    <div class="row">
                        <div class="col-xs-2">
                            <label class="control control--checkbox">
                                <input id="{{act.targetModel.id}}-reaction-treated" type="checkbox" ng-model="act.targetModel.tag['treated']" />
                                <div class="control__indicator control__indicator_alt"></div>
                            </label>
                        </div>
                        <div class="col-xs-10">
                            <label class="lbl-checkbox" for="{{act.targetModel.id}}-reaction-treated">
                                {{ 'locale.encounters.aefi.reactionTreated' | i18n }}
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
