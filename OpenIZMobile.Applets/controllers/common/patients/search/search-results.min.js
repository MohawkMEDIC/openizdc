/*
 * Copyright 2015-2017 Mohawk College of Applied Arts and Technology
 * 
 * 
 * Licensed under the Apache License, Version 2.0 (the "License"); you 
 * may not use this file except in compliance with the License. You may 
 * obtain a copy of the License at 
 * 
 * http://www.apache.org/licenses/LICENSE-2.0 
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the 
 * License for the specific language governing permissions and limitations under 
 * the License.
 * 
 * User: justi
 * Date: 2016-7-24
 */
layoutApp.controller("SearchResultsController",["$scope",function(n){function r(r){if(i=r,t.search.searchSubmitted=!0,!t.searchForm||t.searchForm.$valid){i?t.search.query._onlineOnly=i:delete t.search.query._onlineOnly;t.search.query._offset=0;t.search.query._count=t.search.paging.size;t.search.isSearching=!0;$(i?"#patientOnlineSearchButton":"#patientSearchButton").attr("disabled","disabled");var u=n.search.dateOfBirthStringLow,f=n.search.dateOfBirthStringHigh;OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){var r,i;if(u!==null&&u!==undefined&&f!=null&&f!=undefined&&n.totalResults>0){for(r=[],i=0;i<n.item.length;i++)n.item[i].dateOfBirth<=f&&n.item[i].dateOfBirth>=u&&r.push(n.item[i]);n.item=r}for(t.search.results=n,t.search.paging={current:1,total:n.totalResults==0?1:n.totalResults/t.search.paging.size,size:t.search.paging.size,pages:[]},i=0;i<t.search.paging.total;i++)t.search.paging.pages[i]=i+1},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){t.search.isSearching=!1;$(i?"#patientOnlineSearchButton":"#patientSearchButton").removeAttr("disabled");t.$applyAsync()}})}}function u(){($(i?"#patientOnlineSearchButton":"#patientSearchButton").attr("disabled","disabled"),t.search.paging.current!=t.search.paging.count)&&(t.search.paging.current++,t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size,t.search.query._count=t.search.paging.size,delete t.search.results,t.search.isSearching=!0,OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){t.search.isSearching=!1;$(i?"#patientOnlineSearchButton":"#patientSearchButton").removeAttr("disabled");t.$apply()}}))}function f(){($(i?"#patientOnlineSearchButton":"#patientSearchButton").attr("disabled","disabled"),t.search.paging.current!=1)&&(t.search.paging.current--,t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size,t.search.query._count=t.search.paging.size,delete t.search.results,t.search.isSearching=!0,OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){t.search.isSearching=!1;$(i?"#patientOnlineSearchButton":"#patientSearchButton").removeAttr("disabled");t.$apply()}}))}function e(n){$(i?"#patientOnlineSearchButton":"#patientSearchButton").attr("disabled","disabled");t.search.paging.current=n;t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size;t.search.query._count=t.search.paging.size;delete t.search.results;t.search.isSearching=!0;OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){t.search.isSearching=!1;$(i?"#patientOnlineSearchButton":"#patientSearchButton").removeAttr("disabled");t.$apply()}})}function o(n){t.doStartEncounter(n)}var t=n,i;t.search=t.search||{};t.search.query=t.search.query||{};t.search.results=null;t.search.mode=0;t.search.paging=t.search.paging||{size:10};t.act={};t.$watch("search.dateOfBirthStringLow",function(t){t!==undefined&&(n.search.query.dateOfBirth=">="+OpenIZ.Util.toDateInputString(new Date(t)))});t.$watch("search.dateOfBirthStringHigh",function(t){t!==undefined&&(n.search.query.dateOfBirth="<="+OpenIZ.Util.toDateInputString(new Date(t)))});t.search.search=t.search.search||r;t.search.next=t.search.next||u;t.search.previous=t.search.previous||f;t.search.goPage=t.search.goPage||e;t.startEncounter=o;t.search.searchSubmitted=!1;i=!1}]);