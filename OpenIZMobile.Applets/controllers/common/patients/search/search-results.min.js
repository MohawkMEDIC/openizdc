layoutApp.controller("SearchResultsController",["$scope",function(n){function i(){for(var n in t.search.results.item)OpenIZ.Act.findAsync({query:{classConcept:OpenIZModel.ActClassKeys.Encounter,statusConcept:OpenIZModel.StatusKeys.Active,moodConcept:OpenIZModel.ActMoodKeys.Eventoccurrence,"participation[RecordTarget].player":t.search.results.item[n].id,_count:0},continueWith:function(i){i!=null&&(t.search.results.item[n]._isInEncounter=i.totalResults>0);t.$apply()}})}function r(n){t.search.searchSubmitted=!0;(!t.searchForm||t.searchForm.$valid)&&(n?t.search.query._onlineOnly=n:delete t.search.query._onlineOnly,t.search.query._offset=0,t.search.query._count=t.search.paging.size,t.search.isSearching=!0,OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n;t.search.paging={current:1,total:n.totalResults==0?1:n.totalResults/t.search.paging.size,size:t.search.paging.size,pages:[]};for(var r=0;r<t.search.paging.total;r++)t.search.paging.pages[r]=r+1;i();t.$apply()},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){t.search.isSearching=!1}}))}function u(){(OpenIZ.App.showWait(OpenIZ.Localization.getString("locale.dialog.wait.text")),t.search.paging.current!=t.search.paging.count)&&(t.search.paging.current++,t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size,t.search.query._count=t.search.paging.size,OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n;i();t.$apply()},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){OpenIZ.App.hideWait()}}))}function f(){(OpenIZ.App.showWait(OpenIZ.Localization.getString("locale.dialog.wait.text")),t.search.paging.current!=1)&&(t.search.paging.current--,t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size,t.search.query._count=t.search.paging.size,OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n;i();t.$apply()},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){OpenIZ.App.hideWait()}}))}function e(n){OpenIZ.App.showWait(OpenIZ.Localization.getString("locale.dialog.wait.text"));t.search.paging.current=n;t.search.query._offset=(t.search.paging.current-1)*t.search.paging.size;t.search.query._count=t.search.paging.size;OpenIZ.Patient.findAsync({query:t.search.query,continueWith:function(n){t.search.results=n;i();t.$apply()},onException:function(n){OpenIZ.App.toast(n.message)},"finally":function(){OpenIZ.App.hideWait()}})}function o(n){t.doStartEncounter(n)}var t=n;t.search=t.search||{};t.search.query=t.search.query||{};t.search.results=null;t.search.mode=0;t.search.paging=t.search.paging||{size:10};t.act={};t.$watch("search.dateOfBirthString",function(t){t!==undefined&&(n.search.query.dateOfBirth=OpenIZ.Util.toDateInputString(new Date(t)))});t.search.search=t.search.search||r;t.search.next=t.search.next||u;t.search.previous=t.search.previous||f;t.search.goPage=t.search.goPage||e;t.startEncounter=o;t.search.searchSubmitted=!1}]);