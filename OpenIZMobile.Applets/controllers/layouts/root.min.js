/*
 * Copyright 2015-2017 Mohawk College of Applied Arts and Technology
 * 
 * 
 * Licensed under the Apache License, Version 2.0 (the "License"); you 
 * may not use this file except in compliance with the License. You may 
 * obtain a copy of the License at 
 * 
 * http://www.apache.org/licenses/LICENSE-2.0 
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
 * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the 
 * License for the specific language governing permissions and limitations under 
 * the License.
 * 
 * User: justi
 * Date: 2016-7-24
 */
var layoutApp=angular.module("layout",["openiz","ngSanitize","ui.router","angular.filter"]).config(["$compileProvider","$stateProvider","$urlRouterProvider",function(n,t){n.aHrefSanitizationWhitelist(/^\s*(http|tel):/);n.imgSrcSanitizationWhitelist(/^\s*(http|tel):/);var i=!1;OpenIZ.UserInterface.states.forEach(function(n){i|=n.url=="/";t.state(n)});i||t.state({name:"org-openiz-core-index",url:"/",abstract:!1,views:{"":{controller:"",templateUrl:"/org.openiz.core/views/landing.html"}}})}]).run(function(n){n.isLoading=!0;n.extendToast=null;window.location.hash==""&&(window.location.hash="#/");OpenIZ.Configuration.getConfigurationAsync({continueWith:function(t){n.system={};n.system.config=t;n.$apply()}});n.$on("$stateChangeError",console.log.bind(console));n.$on("$stateChangeStart",function(){$(".modal.in").length>0&&($(".modal-open").removeClass("modal-open"),$(".modal-backdrop").remove());window.scrollTo(0,0);n.isLoading=!0});n.$on("$stateChangeSuccess",function(){OpenIZ.App.hideWait();n.isLoading=!1});n.page={title:OpenIZ.App.getCurrentAssetTitle(),loadTime:new Date,maxEventTime:(new Date).tomorrow(),minEventTime:(new Date).yesterday(),locale:OpenIZ.Localization.getLocale(),onlineState:OpenIZ.App.getOnlineState()};setInterval(function(){var r;if(n.page.onlineState=OpenIZ.App.getOnlineState(),n.session&&n.session.exp-new Date<12e4){var i=Math.round((n.session.exp-new Date)/1e3),u=Math.trunc(i/60),t=i%60;(""+t).length<2&&(t="0"+t);expiryStr=u+":"+t;r=OpenIZ.Localization.getString("locale.session.aboutToExpirePrefix")+expiryStr+OpenIZ.Localization.getString("locale.session.aboutToExpireSuffix");i<0?window.location.reload(!0):n.extendToast?$(n.extendToast).children(".toast-message").html(r):n.extendToast=toastr.error(r,OpenIZ.Localization.getString("locale.session.expiration"),{closeButton:!1,preventDuplicates:!0,onclick:function(){OpenIZ.Authentication.refreshSessionAsync({continueWith:function(t){n.session=t},onException:function(n){n.message?OpenIZ.App.toast(n.message):console.error(n)}});n.extendToast=null;toastr.clear()},positionClass:"toast-bottom-center",timeOut:0,extendedTimeOut:0})}n.$applyAsync()},1e4);OpenIZ.Authentication.getSessionAsync({continueWith:function(t){n.session=t;t!=null&&t.entity!=null&&(t.entity.telecom=t.entity.telecom||{},Object.keys(t.entity.telecom).length==0&&(t.entity.telecom.MobilePhone={value:""}));OpenIZ.Configuration.getUserPreferencesAsync({continueWith:function(t){var r,i;n.session.prefs={};for(r in t.application.setting)i=t.application.setting[r],n.session.prefs[i.key]=i.value;n.$apply()}});n.$apply()}});n.changeInputType=function(n,t){$(n).attr("type",t);$(n).attr("data-max-"+t)!=null&&$(n).attr("max",$(n).attr("data-max-"+t))};n.OpenIZ=OpenIZ});layoutApp.service("queryUrlParameterService",[function(){function n(){for(var t=window.location.href,i=/[\?|\&]([^=]+)\=([^&]+)/g,n={};(match=i.exec(t))!=null;)n[match[1]]=match[2];return n}return{getUrlParameters:n}}]);angular.element(document).ready(function(){$("[data-toggle=popover]").popover({container:"body"});$("[data-toggle=popover]").on("shown.bs.popover",function(){$("[data-toggle=popover]").not(this).popover("hide")});$("#initialBlock").remove();$("#waitModal").removeClass("in");$("#waitModal").removeAttr("style")});layoutApp.factory("encounterFactory",["$q",function(n){var t={appointments:null,patientId:null,pageTime:null,gettingUpcoming:!1};return t.setPageTime=function(n){t.pageTime=n},t.setPatientId=function(n){t.patientId=n},t.getUpcoming=function(){var i=n.defer();return t.gettingUpcoming?t.appointments!==null&&t.appointments!==undefined?i.resolve(t.appointments):i.reject("In Progress"):(t.gettingUpcoming=!0,OpenIZ.CarePlan.getCarePlanAsync({query:"_patientId="+t.patientId+"&_appointments=true&_viewModel=full&stopTime=>"+OpenIZ.Util.toDateInputString(new Date),onDate:new Date,continueWith:function(n){OpenIZ.CarePlan.getCarePlanAsync({query:"_patientId="+t.patientId+"&_appointments=true&_viewModel=full",minDate:(new Date).tomorrow(),maxDate:(new Date).addDays(90),continueWith:function(r){var u;if(console.log(r),r){if(Array.isArray(n.item))for(u=0;u<r.item.length;u++)n.item.push(r.item[u]);else n=r;if(t.appointments=n.item,t.appointments){t.appointments.sort(function(n,t){return n.actTime>t.actTime?1:-1});for(u in t.appointments)t.appointments[u].startTime<t.pageTime&&(t.appointments[u].startTime=t.pageTime);Array.isArray(t.appointments[u])||Array.isArray(t.appointments[u].relationship.HasComponent)||(t.appointments[u].relationship.HasComponent=[t.appointments[u].relationship.HasComponent]);i.resolve(t.appointments);t.gettingUpcoming=!1}}},onException:function(n){n.message?alert(n.message):console.error(n);i.reject(n)}})},onException:function(n){n.message?alert(n.message):console.error(n)}})),i.promise},t}]);