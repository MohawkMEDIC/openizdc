angular.module("openiz",[]).provider("localize",function(){this.$get=["$rootScope","$filter",function(){var n={dictionary:OpenIZ.Localization.getStrings(OpenIZ.Localization.getLocale()),setLanguage:function(t){OpenIZ.Localization.getLocale()!=t&&(OpenIZ.Localization.setLocale(t),n.dictionary=OpenIZ.Localization.getStrings(t))},getString:function(t){var r=n.dictionary[t],i;return r!=null?r:(i=OpenIZ.Localization.getString(t),i==null)?t:i}};return n}]}).filter("i18n",["$rootScope","localize",function(n,t){var i=function(n){return t.getString(n)};return i.$stateful=!1,i}]).filter("translate",function(){return function(n){return OpenIZ.Localization.getString(n)}}).filter("orderStatus",function(){return function(n,t){return n==OpenIZModel.ActMoodKeys.Eventoccurrence&&t==OpenIZModel.StatusKeys.Active?"locale.stock.label.shipped":n==OpenIZModel.ActMoodKeys.Eventoccurrence&&t==OpenIZModel.StatusKeys.Completed?"locale.stock.label.fulfilled":t==OpenIZModel.StatusKeys.Obsolete?"locale.stock.label.cancelled":"locale.stock.label.pending"}}).filter("orderLabel",function(){return function(n,t){return n==OpenIZModel.ActMoodKeys.Eventoccurrence&&t==OpenIZModel.StatusKeys.Active?"info":n==OpenIZModel.ActMoodKeys.Eventoccurrence&&t==OpenIZModel.StatusKeys.Completed?"success":t==OpenIZModel.StatusKeys.Obsolete?"danger":"default"}}).filter("oizSum",function(){return function(n,t){var r=0,i;if(Array.isArray(n))if(t)for(i in n)r+=n[i][t];else for(i in n)r+=n[i];return r}}).filter("oizEntityIdentifier",function(){return function(n){if(n===undefined)return"";if(n.NID!==undefined)return n.NID.value;for(var t in n)return n[t].value}}).filter("oizConcept",function(){return function(n){if(n!=null&&n.name!=null)return OpenIZ.Util.renderConceptName(n.name)}}).filter("oizEntityName",function(){return function(n){return OpenIZ.Util.renderName(n)}}).filter("oizEntityAddress",function(){return function(n){return OpenIZ.Util.renderAddress(n)}}).filter("datePrecisionFormat",function(){return function(n,t){var i;switch(t){case 1:case"Y":i=OpenIZ.App.DatePrecisionFormats.DateFormatYear;break;case 2:case"m":i=OpenIZ.App.DatePrecisionFormats.DateFormatMonth;break;case 3:case"D":i=OpenIZ.App.DatePrecisionFormats.DateFormatDay;break;case 4:case"H":i=OpenIZ.App.DatePrecisionFormats.DateFormatHour;break;case 5:case"M":i=OpenIZ.App.DatePrecisionFormats.DateFormatMinute;break;case 6:case"S":case 0:case"F":default:i=OpenIZ.App.DatePrecisionFormats.DateFormatSecond}return moment(n).format(i)}}).directive("oizTag",function(){return{require:"ngModel",link:function(n,t,i,r){function u(n){return String(n).split(",")}function f(n){return typeof n===Array?n.join(n):n}r.$parsers.unshift(u);r.$formatters.unshift(f);n.$watch(i.ngModel,function(n,i){(typeof n=="string"&&i!=n||Array.isArray(n)&&(!Array.isArray(i)||i.length!=n.length)||$(t).attr("has-bound")===undefined)&&($(t).attr("has-bound",!0),$(t).trigger("change"))});$(t).tokenfield({delimiter:" ,",createTokensOnBlur:!0})}}}).directive("oizDatabind",function(n){return{link:function(t,i,r){n(function(){var p=$(i).attr("oiz-databind"),o=$(i).attr("data-filter"),s=$(i).attr("data-watch"),h=$(i).attr("data-watch-target"),c=$(i).attr("data-display"),f=$(i).attr("data-key"),k=$(i).attr("ng-model"),l=$(i).attr("data-defaultFirst"),e=$(i).attr("data-default"),w=$(i).attr("data-defaultEmpty"),a=$(i).attr("data-whenEmpty"),v=r.defaultKey,d=t.$root,b=t,n=null,u,y;try{n=eval(e)}catch(g){}u={};o!==undefined&&(u=JSON.parse(o));u.statusConcept||(u.statusConcept="C8064CBD-FA06-4530-B430-1A52F1530C27");y=function(){$(i)[0].disabled=!0;OpenIZ.Ims.get({resource:p,query:u,"finally":function(){$(i)[0].disabled=!1},continueWith:function(t){var e=$(i).val(),o=$(i)[0].options,s,r,u,h;$("option",i[0]).remove();t.item&&l||(o[o.length]=v?new Option(OpenIZ.Localization.getString("locale.common.unknown"),v):w?new Option(""):new Option(OpenIZ.Localization.getString("locale.common.unknown")));(!t.item||t.count==0)&&a&&(s=b,eval(a));for(r in t.item)u=null,c!=null?(h=t.item[r],u=eval(c)):u=OpenIZ.Util.renderName(t.item[r].name.OfficialRecord),o[o.length]=f==null?new Option(u,t.item[r].id):new Option(u,eval(f)),r==0&&l&&(n=n||f==null?t.item[r].id:eval(f));e&&e.indexOf("? string:")==0?$(i).val(e.substring(9,e.length-2)):n&&$(i).val(n);$(i).trigger("change")}})};s!==null&&t.$watch(s,function(i){var r=t.$root;h!==null&&i!==undefined&&(u[h]=i,e&&(n=eval(e)||n));y()})})}}}).directive("oizEntitysearch",function(n){return{scope:{defaultResults:"="},link:function(t,i,r){n(function(){var u=r.oizEntitysearch,e=r.filter,f=r.display,c=r.searchfield||"name.component.value",o=r.default,s=r.groupBy,h=r.groupDisplay,l=r.resultfield||"id",n={};e!==undefined&&(n=JSON.parse(e));u!="SecurityUser"&&u!="SecurityRole"&&(n.statusConcept="C8064CBD-FA06-4530-B430-1A52F1530C27");$(i).select2({defaultResults:function(){var n=t;if(o!=null)try{return eval(o)}catch(r){}else return $.map($("option",i[0]),function(n){return{id:n.value,text:n.innerText}})},dataAdapter:$.fn.select2.amd.require("select2/data/extended-ajax"),ajax:{url:(u=="SecurityUser"||u=="SecurityRole"?"/__auth/":"/__ims/")+u,dataType:"json",delay:500,method:"GET",data:function(t){return n[c]="~"+t.term,n._count=5,n._offset=0,n._viewModel="min",n},processResults:function(n){var n=n.item||n,t={results:[]},i,u,r,e;if(s==null)return{results:$.map(n,function(n){var t="";return f?(u=n,t=eval(f)):n.name!==undefined&&(n.name.OfficialRecord?t=OpenIZ.Util.renderName(n.name.OfficialRecord):n.name.Assigned&&(t=OpenIZ.Util.renderName(n.name.Assigned))),n.text=n.text||t,n.id=n[l],n})};for(i in n)try{u=eval("data[itm]."+s);r="";r=h!=null?eval(h):u;e=$.grep(t.results,function(n){return n.text==r});e.length==0?t.results.push({text:r,children:[n[i]]}):e[0].children.push(n[i])}catch(o){t.results.push(n[i])}return t},cache:!0},escapeMarkup:function(n){return n},minimumInputLength:2,templateSelection:function(n){var t="",i;switch(u){case"UserEntity":case"Provider":t+="<span class='glyphicon glyphicon-user'><\/span>";break;case"Place":t+="<span class='glyphicon glyphicon-map-marker'><\/span>";break;case"Entity":t+="<span class='glyphicon glyphicon-tag'><\/span>"}return t+="&nbsp;",f!=null?(i=n,t+=eval(f)):n.name!=null&&n.name.OfficialRecord!=null?t+=OpenIZ.Util.renderName(n.name.OfficialRecord):n.name!=null&&n.name.Assigned!=null?t+=OpenIZ.Util.renderName(n.name.Assigned):n.name!=null&&n.name.$other!=null?t+=OpenIZ.Util.renderName(n.name.$other):n.element!==undefined?t+=n.element.innerText.trim():n.text&&(t+=n.text),t},keepSearchResults:!0,templateResult:function(n){var i,t;return n.loading?n.text:f!=null?(i=n,eval(f)):n.classConcept!=OpenIZModel.EntityClassKeys.ServiceDeliveryLocation&&n.name!=null&&n.typeConceptModel!=null&&n.typeConceptModel.name!=null&&n.name.OfficialRecord?(t="<div class='label label-info'>"+n.typeConceptModel.name[OpenIZ.Localization.getLocale()]+"<\/div> "+OpenIZ.Util.renderName(n.name.OfficialRecord||n.name.$other),n.address&&(t+=" - <small>(<i class='fa fa-map-marker'><\/i> "+OpenIZ.Util.renderAddress(n.address)+")<\/small>"),t):n.classConcept==OpenIZModel.EntityClassKeys.ServiceDeliveryLocation&&n.name!=null&&n.typeConceptModel!=null&&n.typeConceptModel.name!=null?(t="<div class='label label-info'>"+n.typeConceptModel.name[OpenIZ.Localization.getLocale()]+"<\/div> "+OpenIZ.Util.renderName(n.name.OfficialRecord||n.name.Assigned||n.name.$other),n.relationship&&n.relationship.Parent&&n.relationship.Parent.targetModel&&n.relationship.Parent.targetModel.name&&(t+=" - <small>(<i class='fa fa-map-marker'><\/i> "+OpenIZ.Util.renderName(n.relationship.Parent.targetModel.name.OfficialRecord||n.relationship.Parent.targetModel.name.Assigned)+")<\/small>"),n.address&&(t+=" - <small>(<i class='fa fa-map-marker'><\/i> "+OpenIZ.Util.renderAddress(n.address)+")<\/small>"),t):n.name!=null&&n.typeConceptModel!=null&&n.typeConceptModel.name!=null&&n.name.Assigned?(t="<div class='label label-default'>"+n.typeConceptModel.name[OpenIZ.Localization.getLocale()]+"<\/div> "+OpenIZ.Util.renderName(n.name.Assigned||n.name.$other),n.address&&(t+=" - <small>(<i class='fa fa-map-marker'><\/i> "+OpenIZ.Util.renderAddress(n.address)+")<\/small>"),t):n.name!=null&&n.name.OfficialRecord?"<div class='label label-default'>"+n.$type+"<\/div> "+OpenIZ.Util.renderName(n.name.OfficialRecord):n.name!=null&&n.name.Assigned?"<div class='label label-default'>"+n.$type+"<\/div> "+OpenIZ.Util.renderName(n.name.Assigned):n.name!=null&&n.name.$other?"<div class='label label-default'>"+n.$type+"<\/div> "+OpenIZ.Util.renderName(n.name.$other):n.text}});$(i).on("select2:select",function(n){n.currentTarget.value.indexOf("? string:")==0&&(n.currentTarget.value=n.currentTarget.value.substring(9,n.currentTarget.value.length-2));n.currentTarget.options.selectedIndex=n.currentTarget.options.length-1})})}}}).directive("oizCollapseindicator",function(){return{link:function(n,t){$(t).on("hide.bs.collapse",function(){var n=$(this).attr("data-oiz-chevron");$(n).removeClass("glyphicon-chevron-down");$(n).addClass("glyphicon-chevron-right")});$(t).on("show.bs.collapse",function(){var n=$(this).attr("data-oiz-chevron");$(n).addClass("glyphicon-chevron-down");$(n).removeClass("glyphicon-chevron-right")})}}}).directive("ngRepeatN",["$parse",function(n){return{restrict:"A",transclude:"element",replace:!0,scope:!0,link:function(t,i,r,u,f){t.last=i;t.parentElem=i.parent();t.elems=[i];var e=n(r.ngRepeatN);t.$watch(function(){return parseInt(r.ngRepeatN)||e(t)},function(n,i){var u=parseInt(n),s=parseInt(i),h=!isNaN(u)&&!isNaN(s),e,r,o;if(isNaN(u)||h&&u<s)for(o=h?u:0,t.last=t.elems[o],r=t.elems.length-1;r>o;r-=1)t.elems[r].remove(),t.elems.pop();else for(r=t.elems.length-1,r;r<u;r+=1)e=t.$new(),e.$index=r,f(e,function(n){t.last.after(n);t.last=n;t.elems.push(n)})})}}}]).directive("siteTrim",function(){return{replace:!0,restrict:"A",template:"<span>{{site}}<\/span>",link:function(n,t,i){n.site=i.siteTrim.substring(5,i.siteTrim.length)||"N/A"}}}).directive("chartLegend",function(){return{restrict:"E",templateUrl:"views/common/patients/view/partials/chart-legend.html",replace:!0}}).directive("integerMinimumValue",function(){return{require:"?ngModel",link:function(n,t,i,r){if(r){var u=i.integerMinimumValue;r.$formatters.unshift(function(n){return r.$setValidity("integerMinimumValue",n>=u),n});r.$parsers.unshift(function(n){var t=n.replace(/[^0-9]/g,""),i=t>=u;return r.$setValidity("integerMinimumValue",i),t!==n&&(r.$setViewValue(t),r.$render()),i?t:undefined})}}}});